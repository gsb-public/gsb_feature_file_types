<?php
/**
 * @file
 * Code for the gsb_feature_file_types feature.
 */

include_once 'gsb_feature_file_types.features.inc';

/**
 * Implements hook_media_token_to_markup_alter()
 * Alter the output generated by Media filter tags.
 */
function gsb_feature_file_types_media_token_to_markup_alter(&$element, $tag_info, $settings) {
  if (isset($element['content']) && $element['content']['#bundle'] == 'image') {
    $file = $element['content']['file']['#file'];
    if (isset($file->field_file_image_alignment['und'])) {
      $alignment = $file->field_file_image_alignment['und'];
    }
    $style = '';
    if (isset($file->field_file_image_show_caption['und']) && $file->field_file_image_show_caption['und'] == 1 && !is_array($file->field_file_image_show_caption['und'])) {
      $show_caption = TRUE;
    }
    else {
      $show_caption = FALSE;
    }
    if ($show_caption) {
      $title = $element['content']['file']['#title'];
      $width = $element['content']['file']['#width'];
      if ($width) {
        $style = ' style="width:' . $width . 'px;"';
      }
      if (!empty($title)) {
        $element['content']['text'] = array('#markup' => '<div class="caption-text">' . $title . '</div>');
      }
    }
    $element['#prefix'] = '<div class="' . $alignment .'"' . $style . '>';
    $element['#suffix'] = '</div>';
  }
}

/**
 * Implements hook_install().
 */
function gsb_feature_file_types_install() {

  // overriding image view modes preview and teaser which are 
  // initially setup in media.module

  module_load_include('inc', 'file_entity', 'file_entity.file_api');

  $default_image_styles = array(
    'preview' => '450x263',
    'teaser' => '450x263',
  );

  foreach ($default_image_styles as $view_mode => $image_style) {

    $image_displays = file_displays_load('image', $view_mode);

    $display_name = 'image__' . $view_mode . '__file_image';;

    if (isset($image_displays[$display_name])) {
      $display = $image_displays[$display_name];
      $display->settings['image_style'] = $image_style;
      file_display_save((object) $display);
    }
    
  }    

}
